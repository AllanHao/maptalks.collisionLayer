/*!
 * maptalks.collisionLayer v0.1.1
 * LICENSE : MIT
 * (c) 2016-2017 maptalks.org
 */
/*!
 * requires maptalks@>=0.36.0 
 */
!function(t,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports,require("maptalks")):"function"==typeof define&&define.amd?define(["exports","maptalks"],n):n(t.maptalks=t.maptalks||{},t.maptalks)}(this,function(t,n){"use strict";function i(t,n,r,a,o){for(r=r||0,a=a||t.length-1,o=o||function(t,n){return t<n?-1:t>n?1:0};a>r;){if(a-r>600){var h=a-r+1,s=n-r+1,l=Math.log(h),u=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*u*(h-u)/h)*(s-h/2<0?-1:1);i(t,n,Math.max(r,Math.floor(n-s*u/h+c)),Math.min(a,Math.floor(n+(h-s)*u/h+c)),o)}var f=t[n],m=r,p=a;for(e(t,r,n),o(t[a],f)>0&&e(t,r,a);m<p;){for(e(t,m,p),m++,p--;o(t[m],f)<0;)m++;for(;o(t[p],f)>0;)p--}0===o(t[r],f)?e(t,r,p):e(t,++p,a),p<=n&&(r=p+1),n<=p&&(a=p-1)}}function e(t,n,i){var e=t[n];t[n]=t[i],t[i]=e}function r(t,n){if(!(this instanceof r))return new r(t,n);this._maxEntries=Math.max(4,t||9),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),n&&this._initFormat(n),this.clear()}function a(t,n){o(t,0,t.children.length,n,t)}function o(t,n,i,e,r){r||(r=p(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(var a,o=n;o<i;o++)a=t.children[o],h(r,t.leaf?e(a):a);return r}function h(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function s(t,n){return t.minX-n.minX}function l(t,n){return t.minY-n.minY}function u(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function c(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function m(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function d(t,n,i,e,r){for(var a,o=[n,i];o.length;)(i=o.pop())-(n=o.pop())<=e||(a=n+Math.ceil((i-n)/e/2)*e,g(t,a,n,i,r),o.push(n,a,a,i))}function x(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(t,n):function(t,n){for(var i=Object.getOwnPropertyNames(n),e=0;e<i.length;e++){var r=i[e],a=Object.getOwnPropertyDescriptor(n,r);a&&a.configurable&&void 0===t[r]&&Object.defineProperty(t,r,a)}}(t,n))}var g=i,M=r;r.prototype={all:function(){return this._all(this.data,[])},search:function(t){var n=this.data,i=[],e=this.toBBox;if(!m(t,n))return i;for(var r,a,o,h,s=[];n;){for(r=0,a=n.children.length;r<a;r++)o=n.children[r],m(t,h=n.leaf?e(o):o)&&(n.leaf?i.push(o):f(t,h)?this._all(o,i):s.push(o));n=s.pop()}return i},collides:function(t){var n=this.data,i=this.toBBox;if(!m(t,n))return!1;for(var e,r,a,o,h=[];n;){for(e=0,r=n.children.length;e<r;e++)if(a=n.children[e],o=n.leaf?i(a):a,m(t,o)){if(n.leaf||f(t,o))return!0;h.push(a)}n=h.pop()}return!1},load:function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var n=0,i=t.length;n<i;n++)this.insert(t[n]);return this}var e=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){var r=this.data;this.data=e,e=r}this._insert(e,this.data.height-e.height-1,!0)}else this.data=e;return this},insert:function(t){return t&&this._insert(t,this.data.height-1),this},clear:function(){return this.data=p([]),this},remove:function(t,n){if(!t)return this;for(var i,e,r,a,o=this.data,h=this.toBBox(t),s=[],l=[];o||s.length;){if(o||(o=s.pop(),e=s[s.length-1],i=l.pop(),a=!0),o.leaf&&-1!==(r=function(t,n,i){if(!i)return n.indexOf(t);for(var e=0;e<n.length;e++)if(i(t,n[e]))return e;return-1}(t,o.children,n)))return o.children.splice(r,1),s.push(o),this._condense(s),this;a||o.leaf||!f(o,h)?e?(i++,o=e.children[i],a=!1):o=null:(s.push(o),l.push(i),i=0,e=o,o=o.children[0])}return this},toBBox:function(t){return t},compareMinX:s,compareMinY:l,toJSON:function(){return this.data},fromJSON:function(t){return this.data=t,this},_all:function(t,n){for(var i=[];t;)t.leaf?n.push.apply(n,t.children):i.push.apply(i,t.children),t=i.pop();return n},_build:function(t,n,i,e){var r,o=i-n+1,h=this._maxEntries;if(o<=h)return r=p(t.slice(n,i+1)),a(r,this.toBBox),r;e||(e=Math.ceil(Math.log(o)/Math.log(h)),h=Math.ceil(o/Math.pow(h,e-1))),(r=p([])).leaf=!1,r.height=e;var s,l,u,c,f=Math.ceil(o/h),m=f*Math.ceil(Math.sqrt(h));for(d(t,n,i,m,this.compareMinX),s=n;s<=i;s+=m)for(d(t,s,u=Math.min(s+m-1,i),f,this.compareMinY),l=s;l<=u;l+=f)c=Math.min(l+f-1,u),r.children.push(this._build(t,l,c,e-1));return a(r,this.toBBox),r},_chooseSubtree:function(t,n,i,e){for(var r,a,o,h,s,l,c,f;e.push(n),!n.leaf&&e.length-1!==i;){for(c=f=1/0,r=0,a=n.children.length;r<a;r++)s=u(o=n.children[r]),(l=function(t,n){return(Math.max(n.maxX,t.maxX)-Math.min(n.minX,t.minX))*(Math.max(n.maxY,t.maxY)-Math.min(n.minY,t.minY))}(t,o)-s)<f?(f=l,c=s<c?s:c,h=o):l===f&&s<c&&(c=s,h=o);n=h||n.children[0]}return n},_insert:function(t,n,i){var e=this.toBBox,r=i?t:e(t),a=[],o=this._chooseSubtree(r,this.data,n,a);for(o.children.push(t),h(o,r);n>=0&&a[n].children.length>this._maxEntries;)this._split(a,n),n--;this._adjustParentBBoxes(r,a,n)},_split:function(t,n){var i=t[n],e=i.children.length,r=this._minEntries;this._chooseSplitAxis(i,r,e);var o=this._chooseSplitIndex(i,r,e),h=p(i.children.splice(o,i.children.length-o));h.height=i.height,h.leaf=i.leaf,a(i,this.toBBox),a(h,this.toBBox),n?t[n-1].children.push(h):this._splitRoot(i,h)},_splitRoot:function(t,n){this.data=p([t,n]),this.data.height=t.height+1,this.data.leaf=!1,a(this.data,this.toBBox)},_chooseSplitIndex:function(t,n,i){var e,r,a,h,s,l,c,f;for(l=c=1/0,e=n;e<=i-n;e++)h=function(t,n){var i=Math.max(t.minX,n.minX),e=Math.max(t.minY,n.minY),r=Math.min(t.maxX,n.maxX),a=Math.min(t.maxY,n.maxY);return Math.max(0,r-i)*Math.max(0,a-e)}(r=o(t,0,e,this.toBBox),a=o(t,e,i,this.toBBox)),s=u(r)+u(a),h<l?(l=h,f=e,c=s<c?s:c):h===l&&s<c&&(c=s,f=e);return f},_chooseSplitAxis:function(t,n,i){var e=t.leaf?this.compareMinX:s,r=t.leaf?this.compareMinY:l;this._allDistMargin(t,n,i,e)<this._allDistMargin(t,n,i,r)&&t.children.sort(e)},_allDistMargin:function(t,n,i,e){t.children.sort(e);var r,a,s=this.toBBox,l=o(t,0,n,s),u=o(t,i-n,i,s),f=c(l)+c(u);for(r=n;r<i-n;r++)a=t.children[r],h(l,t.leaf?s(a):a),f+=c(l);for(r=i-n-1;r>=n;r--)a=t.children[r],h(u,t.leaf?s(a):a),f+=c(u);return f},_adjustParentBBoxes:function(t,n,i){for(var e=i;e>=0;e--)h(n[e],t)},_condense:function(t){for(var n,i=t.length-1;i>=0;i--)0===t[i].children.length?i>0?(n=t[i-1].children).splice(n.indexOf(t[i]),1):this.clear():a(t[i],this.toBBox)},_initFormat:function(t){var n=["return a"," - b",";"];this.compareMinX=new Function("a","b",n.join(t[0])),this.compareMinY=new Function("a","b",n.join(t[1])),this.toBBox=new Function("a","return {minX: a"+t[0]+", minY: a"+t[1]+", maxX: a"+t[2]+", maxY: a"+t[3]+"};")}};var v=function(t){function i(){return function(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}(this,i),function(t,n){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?t:n}(this,t.apply(this,arguments))}return x(i,t),i.prototype.onAdd=function(){this.map.on("viewchange",this.onViewChange,this),this._rbush=M()},i.prototype.onViewChange=function(){this.updateCollision()},i.prototype.updateCollision=function(){var t=this;this._rbush.clear();this.getGeometries(function(t){return"Point"===t.type&&t}).forEach(function(n){console.log(t.getMarkerPointExtent(n))})},i.prototype.getMarkerPointExtent=function(t){var i=t.getSize(),e=i.width,r=i.height,a=this.map.coordinateToContainerPoint(t.getCoordinates()),o=a.x,h=a.y,s=Math.round(o-e/2),l=Math.round(o+e/2),u=Math.round(h-r/2),c=Math.round(h+r/2);return new n.PointExtent({xmin:s,xmax:l,ymin:u,ymax:c})},i}(n.VectorLayer);v.mergeOptions({activeId:null}),t.CollisionLayer=v,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.collisionLayer v0.1.1, requires maptalks@>=0.36.0.")});